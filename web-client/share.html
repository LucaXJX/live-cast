<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live-Cast åˆ†äº«å±å¹•</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        width: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 32px;
        margin-bottom: 10px;
      }

      .content {
        padding: 30px;
      }

      .screen-preview {
        width: 100%;
        max-width: 640px;
        height: 360px;
        background: #000;
        border-radius: 10px;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .screen-preview video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .screen-preview .placeholder {
        color: white;
        text-align: center;
        font-size: 18px;
      }

      .controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        text-transform: uppercase;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        padding: 20px;
        background: #f5f5f5;
        border-radius: 10px;
        text-align: center;
      }

      .status-item {
        margin: 10px 0;
        font-size: 16px;
      }

      .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ccc;
        margin-right: 8px;
        vertical-align: middle;
      }

      .status-dot.recording {
        background: #eb3349;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      .footer {
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
      }

      .back-link {
        display: inline-block;
        margin-top: 20px;
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.3s;
      }

      .back-link:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .info-box p {
        margin: 5px 0;
        font-size: 14px;
        color: #1976d2;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“º Live-Cast åˆ†äº«å±å¹•</h1>
        <p>é¸æ“‡è¦åˆ†äº«çš„çª—å£æˆ–å±å¹•</p>
      </div>

      <div class="content">
        <div class="info-box">
          <p><strong>ğŸ’¡ æç¤ºï¼š</strong></p>
          <p>â€¢ é»æ“Š"é–‹å§‹åˆ†äº«"æŒ‰éˆ•å¾Œï¼Œç€è¦½å™¨æœƒè¦æ±‚æ‚¨é¸æ“‡è¦åˆ†äº«çš„å…§å®¹</p>
          <p>â€¢ å¯ä»¥é¸æ“‡æ•´å€‹å±å¹•ã€ç‰¹å®šçª—å£æˆ–ç€è¦½å™¨æ¨™ç±¤é </p>
          <p>â€¢ åˆ†äº«çš„å…§å®¹æœƒåœ¨å±€åŸŸç¶²å…§å»£æ’­ï¼Œå…¶ä»–ç”¨æˆ¶å¯ä»¥åœ¨è§€çœ‹é é¢çœ‹åˆ°</p>
        </div>

        <div class="screen-preview" id="preview">
          <div class="placeholder">
            <p>ğŸ“º</p>
            <p>é»æ“Š"é–‹å§‹åˆ†äº«"ä»¥é è¦½å±å¹•å…§å®¹</p>
          </div>
        </div>

        <div class="controls">
          <button class="btn btn-primary" id="startBtn">ğŸ¥ é–‹å§‹åˆ†äº«</button>

          <button class="btn btn-success" id="sendBtn" disabled>
            ğŸ“¤ ç™¼é€åˆ°æœå‹™å™¨
          </button>

          <button class="btn btn-danger" id="stopBtn" disabled>
            â¹ï¸ åœæ­¢åˆ†äº«
          </button>
        </div>

        <div class="status" id="status">
          <div class="status-item">
            <span class="status-dot"></span>
            <span id="statusText">æœªé€£æ¥</span>
          </div>
        </div>
      </div>

      <div class="footer">
        <a href="/" class="back-link">â† è¿”å›è§€çœ‹</a>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const preview = document.getElementById("preview");
      const startBtn = document.getElementById("startBtn");
      const sendBtn = document.getElementById("sendBtn");
      const stopBtn = document.getElementById("stopBtn");
      const statusText = document.getElementById("statusText");
      const statusDot = document.querySelector(".status-dot");

      let stream = null;
      let video = null;
      let canvas = null;
      let ctx = null;
      let isSharing = false;
      let frameInterval = null;
      let frameCount = 0;
      let lastFpsTime = Date.now();

      // é€£æ¥ç‹€æ…‹
      socket.on("connect", () => {
        statusText.textContent = "å·²é€£æ¥åˆ°æœå‹™å™¨";
        statusDot.style.background = "#4CAF50";
      });

      socket.on("disconnect", () => {
        statusText.textContent = "é€£æ¥æ–·é–‹";
        statusDot.style.background = "#ccc";
      });

      // é–‹å§‹åˆ†äº«
      startBtn.addEventListener("click", async () => {
        try {
          // è«‹æ±‚å±å¹•æ•ç²æ¬Šé™
          stream = await navigator.mediaDevices.getDisplayMedia({
            video: {
              displaySurface: "any",
              width: { ideal: 1920, max: 1920 },
              height: { ideal: 1080, max: 1080 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });

          // å‰µå»º video å…ƒç´ é¡¯ç¤ºé è¦½
          video = document.createElement("video");
          video.srcObject = stream;
          video.autoplay = true;
          video.playsinline = true;

          preview.innerHTML = "";
          preview.appendChild(video);

          // å‰µå»º canvas ç”¨æ–¼æˆªåœ–
          canvas = document.createElement("canvas");
          ctx = canvas.getContext("2d");

          // æ›´æ–° UI
          startBtn.disabled = true;
          sendBtn.disabled = false;
          stopBtn.disabled = false;
          statusText.textContent = "å·²é¸æ“‡å±å¹•";

          // ç›£è½åœæ­¢äº‹ä»¶
          stream.getVideoTracks()[0].addEventListener("ended", () => {
            stopSharing();
          });
        } catch (error) {
          console.error("ç²å–å±å¹•å¤±æ•—:", error);
          alert("ç„¡æ³•ç²å–å±å¹•å…§å®¹ï¼š" + error.message);
        }
      });

      // ç™¼é€åˆ°æœå‹™å™¨
      sendBtn.addEventListener("click", () => {
        if (!stream) return;

        isSharing = true;
        sendBtn.disabled = true;
        startBtn.disabled = true;
        statusText.textContent = "æ­£åœ¨åˆ†äº«ä¸­...";
        statusDot.classList.add("recording");

        // å®šæœŸæ•ç²ä¸¦ç™¼é€å¹€
        frameInterval = setInterval(() => {
          captureAndSend();
        }, 33); // ~30 FPS
      });

      // æ•ç²ä¸¦ç™¼é€
      function captureAndSend() {
        if (!video || !isSharing) return;

        try {
          const startTime = performance.now();

          // è¨­ç½® canvas å¤§å°ï¼ˆé™åˆ¶åˆ†è¾¨ç‡ä»¥å„ªåŒ–æ€§èƒ½ï¼‰
          const maxWidth = 1280;
          const maxHeight = 720;
          const videoWidth = video.videoWidth || 1920;
          const videoHeight = video.videoHeight || 1080;

          // æŒ‰æ¯”ä¾‹ç¸®æ”¾
          let canvasWidth = videoWidth;
          let canvasHeight = videoHeight;

          if (canvasWidth > maxWidth || canvasHeight > maxHeight) {
            const ratio = Math.min(
              maxWidth / canvasWidth,
              maxHeight / canvasHeight
            );
            canvasWidth = Math.floor(canvasWidth * ratio);
            canvasHeight = Math.floor(canvasHeight * ratio);
          }

          canvas.width = canvasWidth;
          canvas.height = canvasHeight;

          // ç¹ªè£½è¦–é »å¹€
          ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);

          // è½‰æ›ç‚º Base64ï¼ˆå¹³è¡¡è³ªé‡å’Œæ€§èƒ½ï¼‰
          const dataURL = canvas.toDataURL("image/jpeg", 0.75);

          // çµ±è¨ˆ FPS
          frameCount++;
          const now = Date.now();
          if (now - lastFpsTime > 1000) {
            console.log(
              `ğŸ“Š FPS: ${frameCount}, åœ–åƒå¤§å°: ${(
                dataURL.length / 1024
              ).toFixed(2)} KB`
            );
            frameCount = 0;
            lastFpsTime = now;
          }

          // ç™¼é€åˆ°æœå‹™å™¨
          socket.emit("screen-data", {
            image: dataURL,
            timestamp: now,
          });

          const endTime = performance.now();
          console.log(`â±ï¸ è™•ç†æ™‚é–“: ${(endTime - startTime).toFixed(2)}ms`);
        } catch (error) {
          console.error("æ•ç²å¹€å¤±æ•—:", error);
        }
      }

      // åœæ­¢åˆ†äº«
      function stopSharing() {
        isSharing = false;

        // æ¸…é™¤å®šæ™‚å™¨
        if (frameInterval) {
          clearInterval(frameInterval);
          frameInterval = null;
        }

        // åœæ­¢è¦–é »è»Œé“
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }

        // æ›´æ–° UI
        preview.innerHTML = `
        <div class="placeholder">
          <p>ğŸ“º</p>
          <p>é»æ“Š"é–‹å§‹åˆ†äº«"ä»¥é è¦½å±å¹•å…§å®¹</p>
        </div>
      `;

        startBtn.disabled = false;
        sendBtn.disabled = true;
        stopBtn.disabled = true;
        statusText.textContent = "å·²åœæ­¢";
        statusDot.classList.remove("recording");

        // é€šçŸ¥æœå‹™å™¨åœæ­¢ç™¼é€
        socket.emit("screen-data", { stop: true });
      }

      stopBtn.addEventListener("click", stopSharing);

      // é é¢é—œé–‰æ™‚åœæ­¢åˆ†äº«
      window.addEventListener("beforeunload", () => {
        if (isSharing) {
          socket.emit("screen-data", { stop: true });
        }
      });
    </script>
  </body>
</html>
